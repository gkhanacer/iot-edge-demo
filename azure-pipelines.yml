parameters:
  # ── Infrastructure provisioning (independent, optional) ────────────────────
  - name: deployInfraDev
    displayName: 'Provision Infra — Dev'
    type: boolean
    default: false
  - name: deployInfraTest
    displayName: 'Provision Infra — Test'
    type: boolean
    default: false
  - name: deployInfraProd
    displayName: 'Provision Infra — Prod'
    type: boolean
    default: false

  # ── Edge deployments ────────────────────────────────────────────────────────
  - name: deployDevEdge
    displayName: 'Deploy Edge — Dev'
    type: boolean
    default: true
  - name: devDeployTarget
    displayName: 'Dev — Device target'
    type: string
    default: single
    values:
      - single   # deploy to devDeviceId only
      - all      # deploy to all devices with tags.env='dev'
  - name: devDeviceId
    displayName: 'Dev — Device ID (used when target=single)'
    type: string
    default: $(EDGE_DEVICE_ID_DEV)

  - name: deployTestEdge
    displayName: 'Deploy Edge — Test'
    type: boolean
    default: false
  - name: testDeployTarget
    displayName: 'Test — Device target'
    type: string
    default: single
    values:
      - single
      - all
  - name: testDeviceId
    displayName: 'Test — Device ID (used when target=single)'
    type: string
    default: $(EDGE_DEVICE_ID_TEST)

  - name: deployProdEdge
    displayName: 'Deploy Edge — Prod'
    type: boolean
    default: false
  - name: prodDeployTarget
    displayName: 'Prod — Device target'
    type: string
    default: single
    values:
      - single
      - all
  - name: prodDeviceId
    displayName: 'Prod — Device ID (used when target=single)'
    type: string
    default: $(EDGE_DEVICE_ID_PROD)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - modules/**
      - shared/**
      - infra/**
      - deployment/**

pr:
  branches:
    include:
      - main
      - develop

variables:
  PYTHON_VERSION: '3.12'
  MODULES: solar-module battery-module boiler-module controller-module telemetry-module

stages:

  # ── Stage 1: Test (always) ─────────────────────────────────────────────────
  - stage: Test
    displayName: 'Test'
    jobs:
      - job: TestModules
        displayName: 'Test'
        strategy:
          matrix:
            solar:
              MODULE: solar-module
            battery:
              MODULE: battery-module
            boiler:
              MODULE: boiler-module
            controller:
              MODULE: controller-module
            telemetry:
              MODULE: telemetry-module
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: pipelines/templates/test-module.yml
            parameters:
              moduleName: $(MODULE)

      - job: LintAndTypeCheck
        displayName: 'Lint & Type Check'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(PYTHON_VERSION)'
          - script: pip install ruff mypy
            displayName: 'Install linting tools'
          - script: ruff check modules/ shared/
            displayName: 'Ruff lint'
          - script: |
              for module in $(MODULES); do
                mypy modules/$module/src --ignore-missing-imports || true
              done
            displayName: 'Mypy type check'

  # ── Stage 2: Build & Push (once — shared ACR) ──────────────────────────────
  # Tag strategy:
  #   main branch  → <VERSION>          e.g. 3.14        (+ latest)
  #   other branch → <VERSION>-<sha8>   e.g. 3.14-abc12345
  - stage: Build
    displayName: 'Build & Push'
    dependsOn: Test
    condition: and(succeeded('Test'), or(eq('${{ parameters.deployDevEdge }}', 'true'), eq('${{ parameters.deployTestEdge }}', 'true'), eq('${{ parameters.deployProdEdge }}', 'true')))
    jobs:
      - job: ComputeTag
        displayName: 'Compute image tag'
        pool:
          vmImage: ubuntu-latest
        steps:
          - script: |
              VERSION=$(cat VERSION)
              if [ "$(Build.SourceBranch)" = "refs/heads/main" ]; then
                TAG="$VERSION"
              else
                SHORT_SHA=$(echo "$(Build.SourceVersion)" | cut -c1-8)
                TAG="${VERSION}-${SHORT_SHA}"
              fi
              echo "Image tag: $TAG"
              echo "##vso[task.setvariable variable=imageTag;isOutput=true]$TAG"
            name: setTag
            displayName: 'Set image tag from VERSION + branch'

      - job: BuildImages
        displayName: 'Build'
        dependsOn: ComputeTag
        variables:
          imageTag: $[ dependencies.ComputeTag.outputs['setTag.imageTag'] ]
        strategy:
          matrix:
            solar:
              MODULE: solar-module
            battery:
              MODULE: battery-module
            boiler:
              MODULE: boiler-module
            controller:
              MODULE: controller-module
            telemetry:
              MODULE: telemetry-module
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: pipelines/templates/build-module.yml
            parameters:
              moduleName: $(MODULE)
              registryAddress: $(ACR_LOGIN_SERVER)
              imageTag: $(imageTag)

  # ══════════════════════════════════════════════════════════════════════════
  # INFRA — independent stages, depend only on Test
  # ══════════════════════════════════════════════════════════════════════════

  - stage: Infra_Dev
    displayName: '[Dev] Provision Infrastructure'
    dependsOn: Test
    condition: and(succeeded('Test'), eq('${{ parameters.deployInfraDev }}', 'true'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — dev'
        environment: iot-edge-dev
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — dev'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_DEV) \
                        --location westeurope \
                        --tags env=dev project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_DEV) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=dev \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-dev-$(Build.BuildId)"

  - stage: Infra_Test
    displayName: '[Test] Provision Infrastructure'
    dependsOn: Test
    condition: and(succeeded('Test'), eq('${{ parameters.deployInfraTest }}', 'true'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — test'
        environment: iot-edge-test
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — test'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_TEST) \
                        --location westeurope \
                        --tags env=test project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_TEST) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=test \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-test-$(Build.BuildId)"

  - stage: Infra_Prod
    displayName: '[Prod] Provision Infrastructure'
    dependsOn: Test
    condition: and(succeeded('Test'), eq('${{ parameters.deployInfraProd }}', 'true'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — prod'
        environment: iot-edge-prod
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — prod'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_PROD) \
                        --location westeurope \
                        --tags env=prod project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_PROD) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=prod \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-prod-$(Build.BuildId)"

  # ══════════════════════════════════════════════════════════════════════════
  # EDGE DEPLOYMENTS — promotion chain: dev → test → prod
  # Deploy stages depend only on Build + previous env deploy (NOT on Infra)
  # ══════════════════════════════════════════════════════════════════════════

  - stage: Deploy_Dev
    displayName: '[Dev] Deploy to Edge'
    dependsOn: Build
    condition: and(eq('${{ parameters.deployDevEdge }}', 'true'), succeeded('Build'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — dev (${{ parameters.devDeployTarget }})'
        environment: iot-edge-dev
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureCLI@2
                  displayName: 'Deploy to IoT Edge — dev'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az extension add --name azure-iot --yes 2>/dev/null || true

                      if [ "${{ parameters.devDeployTarget }}" = "all" ]; then
                        echo "Deploying to ALL dev devices (tags.env='dev')"
                        az iot edge deployment create \
                          --hub-name $(IOT_HUB_NAME_DEV) \
                          --content deployment/deployment.template.json \
                          --deployment-id "deploy-dev-$(Build.BuildId)" \
                          --target-condition "tags.env='dev'" \
                          --priority 10
                      else
                        echo "Deploying to device: ${{ parameters.devDeviceId }}"
                        az iot edge set-modules \
                          --hub-name $(IOT_HUB_NAME_DEV) \
                          --device-id "${{ parameters.devDeviceId }}" \
                          --content deployment/deployment.template.json
                      fi

  - stage: Deploy_Test
    displayName: '[Test] Deploy to Edge'
    dependsOn:
      - Build
      - Deploy_Dev
    condition: and(eq('${{ parameters.deployTestEdge }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — test (${{ parameters.testDeployTarget }})'
        environment: iot-edge-test
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureCLI@2
                  displayName: 'Deploy to IoT Edge — test'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az extension add --name azure-iot --yes 2>/dev/null || true

                      if [ "${{ parameters.testDeployTarget }}" = "all" ]; then
                        echo "Deploying to ALL test devices (tags.env='test')"
                        az iot edge deployment create \
                          --hub-name $(IOT_HUB_NAME_TEST) \
                          --content deployment/deployment.template.json \
                          --deployment-id "deploy-test-$(Build.BuildId)" \
                          --target-condition "tags.env='test'" \
                          --priority 10
                      else
                        echo "Deploying to device: ${{ parameters.testDeviceId }}"
                        az iot edge set-modules \
                          --hub-name $(IOT_HUB_NAME_TEST) \
                          --device-id "${{ parameters.testDeviceId }}" \
                          --content deployment/deployment.template.json
                      fi

  - stage: Deploy_Prod
    displayName: '[Prod] Deploy to Edge'
    dependsOn:
      - Build
      - Deploy_Dev
      - Deploy_Test
    condition: and(eq('${{ parameters.deployProdEdge }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'), in(dependencies.Deploy_Test.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — prod (${{ parameters.prodDeployTarget }})'
        environment: iot-edge-prod
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureCLI@2
                  displayName: 'Deploy to IoT Edge — prod'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az extension add --name azure-iot --yes 2>/dev/null || true

                      if [ "${{ parameters.prodDeployTarget }}" = "all" ]; then
                        echo "Deploying to ALL prod devices (tags.env='prod')"
                        az iot edge deployment create \
                          --hub-name $(IOT_HUB_NAME_PROD) \
                          --content deployment/deployment.template.json \
                          --deployment-id "deploy-prod-$(Build.BuildId)" \
                          --target-condition "tags.env='prod'" \
                          --priority 10
                      else
                        echo "Deploying to device: ${{ parameters.prodDeviceId }}"
                        az iot edge set-modules \
                          --hub-name $(IOT_HUB_NAME_PROD) \
                          --device-id "${{ parameters.prodDeviceId }}" \
                          --content deployment/deployment.template.json
                      fi
