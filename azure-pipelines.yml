parameters:
  - name: deployDev
    displayName: 'Deploy to Dev'
    type: boolean
    default: true
  - name: deployTest
    displayName: 'Deploy to Test'
    type: boolean
    default: false
  - name: deployProd
    displayName: 'Deploy to Prod'
    type: boolean
    default: false
  - name: provisionInfra
    displayName: 'Provision Infrastructure'
    type: boolean
    default: false

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - modules/**
      - shared/**
      - infra/**
      - deployment/**

pr:
  branches:
    include:
      - main
      - develop

variables:
  PYTHON_VERSION: '3.12'
  MODULES: solar-module battery-module boiler-module controller-module telemetry-module

stages:

  # ── Stage 1: Test (always) ─────────────────────────────────────────────────
  - stage: Test
    displayName: 'Test'
    jobs:
      - job: TestModules
        displayName: 'Test'
        strategy:
          matrix:
            solar:
              MODULE: solar-module
            battery:
              MODULE: battery-module
            boiler:
              MODULE: boiler-module
            controller:
              MODULE: controller-module
            telemetry:
              MODULE: telemetry-module
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: pipelines/templates/test-module.yml
            parameters:
              moduleName: $(MODULE)

      - job: LintAndTypeCheck
        displayName: 'Lint & Type Check'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(PYTHON_VERSION)'
          - script: pip install ruff mypy
            displayName: 'Install linting tools'
          - script: ruff check modules/ shared/
            displayName: 'Ruff lint'
          - script: |
              for module in $(MODULES); do
                mypy modules/$module/src --ignore-missing-imports || true
              done
            displayName: 'Mypy type check'

  # ── Stage 2: Build & Push (once — shared ACR) ──────────────────────────────
  # Runs when at least one environment is selected for deployment.
  # Tag strategy:
  #   main branch  → <VERSION>          e.g. 3.14        (+ latest)
  #   other branch → <VERSION>-<sha8>   e.g. 3.14-abc12345
  - stage: Build
    displayName: 'Build & Push'
    dependsOn: Test
    condition: and(succeeded('Test'), or(eq('${{ parameters.deployDev }}', 'true'), eq('${{ parameters.deployTest }}', 'true'), eq('${{ parameters.deployProd }}', 'true')))
    jobs:
      - job: ComputeTag
        displayName: 'Compute image tag'
        pool:
          vmImage: ubuntu-latest
        steps:
          - script: |
              VERSION=$(cat VERSION)
              if [ "$(Build.SourceBranch)" = "refs/heads/main" ]; then
                TAG="$VERSION"
              else
                SHORT_SHA=$(echo "$(Build.SourceVersion)" | cut -c1-8)
                TAG="${VERSION}-${SHORT_SHA}"
              fi
              echo "Image tag: $TAG"
              echo "##vso[task.setvariable variable=imageTag;isOutput=true]$TAG"
            name: setTag
            displayName: 'Set image tag from VERSION + branch'

      - job: BuildImages
        displayName: 'Build'
        dependsOn: ComputeTag
        variables:
          imageTag: $[ dependencies.ComputeTag.outputs['setTag.imageTag'] ]
        strategy:
          matrix:
            solar:
              MODULE: solar-module
            battery:
              MODULE: battery-module
            boiler:
              MODULE: boiler-module
            controller:
              MODULE: controller-module
            telemetry:
              MODULE: telemetry-module
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: pipelines/templates/build-module.yml
            parameters:
              moduleName: $(MODULE)
              registryAddress: $(ACR_LOGIN_SERVER)
              imageTag: $(imageTag)

  # ══════════════════════════════════════════════════════════════════════════
  # DEV
  # ══════════════════════════════════════════════════════════════════════════

  - stage: Infra_Dev
    displayName: '[Dev] Provision Infrastructure'
    dependsOn: Build
    condition: and(succeeded('Build'), eq('${{ parameters.deployDev }}', 'true'), eq('${{ parameters.provisionInfra }}', 'true'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — dev'
        environment: iot-edge-dev
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — dev'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_DEV) \
                        --location westeurope \
                        --tags env=dev project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_DEV) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=dev \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-dev-$(Build.BuildId)"

  - stage: Deploy_Dev
    displayName: '[Dev] Deploy to Edge'
    dependsOn:
      - Build
      - Infra_Dev
    condition: and(eq('${{ parameters.deployDev }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Infra_Dev.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — dev'
        environment: iot-edge-dev
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureIoTEdge@2
                  displayName: 'Deploy modules to IoT Edge'
                  inputs:
                    action: 'Deploy Modules'
                    deploymentFilePath: deployment/deployment.template.json
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    iothubname: $(IOT_HUB_NAME_DEV)
                    deviceId: $(EDGE_DEVICE_ID_DEV)
                    deploymentid: 'deploy-dev-$(Build.BuildId)'

  # ══════════════════════════════════════════════════════════════════════════
  # TEST  (waits for Dev if Dev is also selected → dev → test promotion)
  # ══════════════════════════════════════════════════════════════════════════

  - stage: Infra_Test
    displayName: '[Test] Provision Infrastructure'
    dependsOn:
      - Build
      - Deploy_Dev
    condition: and(eq('${{ parameters.deployTest }}', 'true'), eq('${{ parameters.provisionInfra }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — test'
        environment: iot-edge-test
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — test'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_TEST) \
                        --location westeurope \
                        --tags env=test project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_TEST) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=test \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-test-$(Build.BuildId)"

  - stage: Deploy_Test
    displayName: '[Test] Deploy to Edge'
    dependsOn:
      - Build
      - Deploy_Dev
      - Infra_Test
    condition: and(eq('${{ parameters.deployTest }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'), in(dependencies.Infra_Test.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — test'
        environment: iot-edge-test
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureIoTEdge@2
                  displayName: 'Deploy modules to IoT Edge'
                  inputs:
                    action: 'Deploy Modules'
                    deploymentFilePath: deployment/deployment.template.json
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    iothubname: $(IOT_HUB_NAME_TEST)
                    deviceId: $(EDGE_DEVICE_ID_TEST)
                    deploymentid: 'deploy-test-$(Build.BuildId)'

  # ══════════════════════════════════════════════════════════════════════════
  # PROD  (waits for Test if Test is selected → test → prod promotion)
  #        iot-edge-prod environment = manual approval gate in Azure DevOps
  # ══════════════════════════════════════════════════════════════════════════

  - stage: Infra_Prod
    displayName: '[Prod] Provision Infrastructure'
    dependsOn:
      - Build
      - Deploy_Dev
      - Deploy_Test
    condition: and(eq('${{ parameters.deployProd }}', 'true'), eq('${{ parameters.provisionInfra }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'), in(dependencies.Deploy_Test.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployBicep
        displayName: 'Bicep — prod'
        environment: iot-edge-prod
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Bicep — prod'
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az group create \
                        --name $(RESOURCE_GROUP_PROD) \
                        --location westeurope \
                        --tags env=prod project=energy-edge

                      az deployment group create \
                        --resource-group $(RESOURCE_GROUP_PROD) \
                        --template-file infra/main.bicep \
                        --parameters infra/main.bicepparam \
                        --parameters env=prod \
                        --parameters alertEmailAddress=$(ALERT_EMAIL) \
                        --name "deploy-prod-$(Build.BuildId)"

  - stage: Deploy_Prod
    displayName: '[Prod] Deploy to Edge'
    dependsOn:
      - Build
      - Deploy_Dev
      - Deploy_Test
      - Infra_Prod
    condition: and(eq('${{ parameters.deployProd }}', 'true'), in(dependencies.Build.result, 'Succeeded'), in(dependencies.Deploy_Dev.result, 'Succeeded', 'Skipped'), in(dependencies.Deploy_Test.result, 'Succeeded', 'Skipped'), in(dependencies.Infra_Prod.result, 'Succeeded', 'Skipped'))
    jobs:
      - deployment: DeployToEdge
        displayName: 'IoT Edge — prod'
        environment: iot-edge-prod
        pool:
          vmImage: ubuntu-latest
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    sed -i "s|\$CONTAINER_REGISTRY_ADDRESS|$(ACR_LOGIN_SERVER)|g" deployment/deployment.template.json
                    sed -i "s|\$MODULE_VERSION|$(Build.BuildId)|g" deployment/deployment.template.json
                  displayName: 'Substitute deployment variables'
                - task: AzureIoTEdge@2
                  displayName: 'Deploy modules to IoT Edge'
                  inputs:
                    action: 'Deploy Modules'
                    deploymentFilePath: deployment/deployment.template.json
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    iothubname: $(IOT_HUB_NAME_PROD)
                    deviceId: $(EDGE_DEVICE_ID_PROD)
                    deploymentid: 'deploy-prod-$(Build.BuildId)'
