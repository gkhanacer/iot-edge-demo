parameters:
  - name: moduleName
    type: string
  - name: registryAddress
    type: string
  - name: imageTag
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Build & push â€” ${{ parameters.moduleName }}'
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        ACR_NAME=$(echo "${{ parameters.registryAddress }}" | cut -d. -f1)

        # On main branch also push :latest; on feature branches versioned tag only
        LATEST_TAG=""
        if [ "$(Build.SourceBranch)" = "refs/heads/main" ]; then
          LATEST_TAG="--image ${{ parameters.moduleName }}:latest"
        fi

        az acr build \
          --registry "$ACR_NAME" \
          --image "${{ parameters.moduleName }}:${{ parameters.imageTag }}" \
          $LATEST_TAG \
          --file modules/${{ parameters.moduleName }}/Dockerfile \
          .
