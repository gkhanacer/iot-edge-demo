parameters:
  - name: moduleName
    type: string
  - name: registryAddress
    type: string
  - name: imageTag
    type: string
    default: $(Build.BuildId)

steps:
  - task: AzureCLI@2
    displayName: 'Build & push â€” ${{ parameters.moduleName }}'
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az acr build \
          --registry $(echo "${{ parameters.registryAddress }}" | cut -d. -f1) \
          --image "${{ parameters.moduleName }}:${{ parameters.imageTag }}" \
          --image "${{ parameters.moduleName }}:latest" \
          --file modules/${{ parameters.moduleName }}/Dockerfile \
          .
